{
  "version": "0",
  "id": "{{ random_guid() }}",
  "detail-type": "GuardDuty Finding",
  "source": "aws.guardduty",
  "account": "{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}",
  "time": "{{ now() | iso8601 }}",
  "region": "{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2', 'eu-west-1']) }}",
  "resources": [],
  "detail": {
    "schemaVersion": "2.0",
    "accountId": "{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}",
    "region": "{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2']) }}",
    "partition": "aws",
    "id": "{{ random_hex(32, 32) }}",
    "arn": "arn:aws:guardduty:{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2']) }}:{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}:detector/{{ random_string(12) }}/finding/{{ random_hex(32, 32) }}",
    "type": "Object:S3/MaliciousFile",
    "resource": {
      "resourceType": "S3Bucket",
      "s3BucketDetails": [
        {
          "name": "{{ random_choice(['data', 'logs', 'backups', 'analytics', 'uploads']) }}-bucket-{{ random_int(100000, 999999) }}",
          "arn": "arn:aws:s3:::{{ random_choice(['data', 'logs', 'backups']) }}-bucket-{{ random_int(100000, 999999) }}",
          "type": "{{ random_choice(['Destination', 'Source']) }}",
          "createdAt": "{{ (now() | subtract_seconds(random_int(864000, 31536000))) | iso8601 }}",
          "owner": {
            "id": "{{ random_string(64, 'abcdef0123456789') }}"
          },
          "tags": [
            {
              "key": "Environment",
              "value": "{{ random_choice(['Production', 'Development', 'Staging']) }}"
            }
          ],
          "publicAccess": {
            "permissionConfiguration": {
              "accountLevelPermissions": {
                "blockPublicAccess": {
                  "blockPublicAcls": {{ random_choice(['true', 'false']) }},
                  "blockPublicPolicy": {{ random_choice(['true', 'false']) }}
                }
              }
            },
            "effectivePermission": "{{ random_choice(['PUBLIC', 'NOT_PUBLIC']) }}"
          }
        }
      ]
    },
    "service": {
      "serviceName": "guardduty",
      "detectorId": "{{ random_hex(32, 32) }}",
      "malwareProtectionScanDetails": {
        "scanId": "{{ random_guid() }}",
        "scanStartTime": "{{ (now() | subtract_seconds(random_int(3600, 86400))) | iso8601 }}",
        "scanEndTime": "{{ (now() | subtract_seconds(random_int(0, 3600))) | iso8601 }}",
        "scannedResourceDetails": {
          "bucketArn": "arn:aws:s3:::{{ random_choice(['data', 'logs', 'backups']) }}-bucket-{{ random_int(100000, 999999) }}",
          "objectKey": "{{ random_choice(['uploads/malware.exe', 'data/suspicious.zip', 'backups/virus.tar.gz', 'downloads/trojan.bin', 'temp/malicious.dll', 'files/backdoor.sh']) }}",
          "objectVersionId": "{{ random_choice(['null', random_string(32, 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=')]) }}",
          "accountId": "{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}"
        },
        "triggerFindingId": "{{ random_hex(32, 32) }}",
        "sources": [
          "{{ random_choice(['THREAT_DETECTION', 'SCHEDULED_SCAN', 'ON_DEMAND']) }}"
        ]
      },
      "action": {
        "actionType": "AWS_API_CALL",
        "awsApiCallAction": {
          "api": "PutObject",
          "serviceName": "s3.amazonaws.com",
          "remoteIpDetails": {
            "ipAddressV4": "{{ random_public_ip() }}",
            "organization": {
              "asn": {{ random_int(1, 65535) }},
              "asnOrg": "{{ random_choice(['AS-AMAZON', 'AS-GOOGLE', 'AS-UNKNOWN']) }}",
              "isp": "{{ random_choice(['Amazon Technologies Inc.', 'Google LLC', 'Unknown ISP']) }}",
              "org": "{{ random_choice(['Amazon', 'Google Cloud', 'Unknown']) }}"
            },
            "country": {
              "countryName": "{{ random_choice(['United States', 'China', 'Germany']) }}"
            }
          },
          "userAgent": "{{ random_choice(['aws-cli/2.13.5', 'Boto3/1.26.137', 'Mozilla/5.0']) }}"
        }
      },
      "resourceRole": "TARGET",
      "eventFirstSeen": "{{ (now() | subtract_seconds(random_int(0, 3600))) | iso8601 }}",
      "eventLastSeen": "{{ now() | iso8601 }}",
      "archived": false,
      "count": 1,
      "additionalInfo": {
        "threatsDetectedItemCount": {{ random_int(1, 32) }},
        "threatsDetected": [
          {
            "threatName": "{{ random_choice(['Trojan.Win32.Generic', 'Trojan.Linux.Generic', 'Backdoor.Linux.Generic', 'Virus.Win32.Generic', 'Ransomware.Win32.Generic', 'Spyware.Win32.Generic', 'Rootkit.Linux.Generic', 'Miner.Linux.Generic', 'Worm.Win32.Generic', 'Adware.Mac.Generic']) }}",
            "severity": {{ random_choice([5, 8, 8, 8]) }},
            "itemCount": {{ random_int(1, 5) }},
            "files": [
              {
                "filePath": "{{ random_choice(['uploads/malware.exe', 'data/suspicious.zip', 'backups/virus.tar.gz']) }}",
                "fileName": "{{ random_choice(['malware.exe', 'suspicious.zip', 'virus.tar.gz', 'trojan.bin', 'malicious.dll']) }}",
                "fileHash": "{{ random_string(64, 'abcdef0123456789') }}",
                "fileHashType": "SHA256"
              }
            ]
          }
        ],
        "sample": false
      }
    },
    "severity": {{ random_choice([5, 8, 8, 8]) }},
    "createdAt": "{{ (now() | subtract_seconds(random_int(0, 7200))) | iso8601 }}",
    "updatedAt": "{{ now() | iso8601 }}",
    "title": "Malicious file detected on scanned S3 object",
    "description": "A malware scan has detected the listed S3 object to be malicious. This finding indicates that the uploaded object that initiated the malware scan contains a potentially malicious file."
  }
}

