{
  "version": "0",
  "id": "{{ random_guid() }}",
  "detail-type": "GuardDuty Finding",
  "source": "aws.guardduty",
  "account": "{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}",
  "time": "{{ now() | iso8601 }}",
  "region": "{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2', 'eu-west-1']) }}",
  "resources": [],
  "detail": {
    "schemaVersion": "2.0",
    "accountId": "{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}",
    "region": "{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2']) }}",
    "partition": "aws",
    "id": "{{ random_hex(32, 32) }}",
    "arn": "arn:aws:guardduty:{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2']) }}:{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}:detector/{{ random_string(12) }}/finding/{{ random_hex(32, 32) }}",
    "type": "{{ random_choice([
      'Execution:EC2/MaliciousFile!Snapshot',
      'Execution:EC2/MaliciousFile!AMI',
      'Execution:EC2/MaliciousFile!RecoveryPoint',
      'Execution:S3/MaliciousFile!RecoveryPoint'
    ]) }}",
    "resource": {
      "resourceType": "{{ random_choice(['Instance', 'Snapshot', 'AMI', 'RecoveryPoint', 'S3Bucket']) }}",
      "instanceDetails": {
        "instanceId": "i-{{ random_hex(17, 17) }}",
        "instanceType": "{{ random_choice(['t2.micro', 't2.small', 't3.micro', 't3.small', 'm5.large']) }}",
        "launchTime": {{ (now() | unix_timestamp) - random_int(3600, 2592000) }}000,
        "networkInterfaces": [{
          "ipv6Addresses": [],
          "privateDnsName": "ip-{{ random_private_ip() | replace('.', '-') }}.{{ random_choice(['us-east-1', 'us-west-2']) }}.compute.internal",
          "privateIpAddress": "{{ random_private_ip() }}",
          "subnetId": "subnet-{{ random_hex(8, 8) }}",
          "vpcId": "vpc-{{ random_hex(8, 8) }}"
        }],
        "imageId": "ami-{{ random_hex(8, 8) }}",
        "imageDescription": "{{ random_choice(['Amazon Linux 2023', 'Amazon Linux 2', 'Ubuntu Server 22.04 LTS']) }}"
      },
      "s3BucketDetails": [
        {
          "name": "{{ random_choice(['backup', 'recovery', 'snapshot']) }}-bucket-{{ random_int(100000, 999999) }}",
          "arn": "arn:aws:s3:::{{ random_choice(['backup', 'recovery']) }}-bucket-{{ random_int(100000, 999999) }}",
          "type": "Source",
          "createdAt": "{{ (now() | subtract_seconds(random_int(864000, 31536000))) | iso8601 }}",
          "owner": {
            "id": "{{ random_string(64, 'abcdef0123456789') }}"
          }
        }
      ]
    },
    "service": {
      "serviceName": "guardduty",
      "detectorId": "{{ random_hex(32, 32) }}",
      "malwareProtectionScanDetails": {
        "scanId": "{{ random_guid() }}",
        "scanStartTime": "{{ (now() | subtract_seconds(random_int(3600, 86400))) | iso8601 }}",
        "scanEndTime": "{{ (now() | subtract_seconds(random_int(0, 3600))) | iso8601 }}",
        "scannedResourceDetails": {
          "snapshotArn": "arn:aws:ec2:{{ random_choice(['us-east-1', 'us-east-2']) }}:snapshot/snap-{{ random_hex(8, 8) }}",
          "amiArn": "arn:aws:ec2:{{ random_choice(['us-east-1', 'us-east-2']) }}::image/ami-{{ random_hex(8, 8) }}",
          "recoveryPointArn": "arn:aws:backup:{{ random_choice(['us-east-1', 'us-east-2']) }}:{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}:recovery-point:{{ random_choice(['EC2', 'S3']) }}:{{ random_string(32) }}",
          "accountId": "{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}",
          "volumeDetails": [
            {
              "volumeArn": "arn:aws:ec2:{{ random_choice(['us-east-1', 'us-east-2']) }}:volume/vol-{{ random_hex(8, 8) }}",
              "volumeType": "{{ random_choice(['gp3', 'gp2', 'io1']) }}",
              "deviceName": "/dev/sda1",
              "volumeSizeInGB": {{ random_int(20, 500) }},
              "encryptionType": "{{ random_choice(['ENCRYPTED', 'NOT_ENCRYPTED']) }}"
            }
          ]
        },
        "triggerFindingId": "{{ random_hex(32, 32) }}",
        "sources": [
          "{{ random_choice(['THREAT_DETECTION', 'SCHEDULED_SCAN', 'ON_DEMAND']) }}"
        ]
      },
      "resourceRole": "TARGET",
      "eventFirstSeen": "{{ (now() | subtract_seconds(random_int(0, 3600))) | iso8601 }}",
      "eventLastSeen": "{{ now() | iso8601 }}",
      "archived": false,
      "count": 1,
      "additionalInfo": {
        "threatsDetectedItemCount": {{ random_int(1, 32) }},
        "threatsDetected": [
          {
            "threatName": "{{ random_choice(['Trojan.Win32.Generic', 'Trojan.Linux.Generic', 'Backdoor.Linux.Generic', 'Virus.Win32.Generic', 'Ransomware.Win32.Generic', 'Spyware.Win32.Generic', 'Rootkit.Linux.Generic', 'Miner.Linux.Generic', 'Worm.Win32.Generic', 'PUA.Win32.Generic']) }}",
            "severity": {{ random_choice([2, 5, 8, 8, 8]) }},
            "itemCount": {{ random_int(1, 10) }},
            "files": [
              {
                "filePath": "{{ random_choice(['/tmp/malware.exe', '/var/tmp/suspicious.sh', '/root/.ssh/backdoor', '/usr/local/bin/trojan', '/home/ubuntu/downloads/virus', '/opt/malware/bin']) }}",
                "fileName": "{{ random_choice(['malware.exe', 'suspicious.sh', 'backdoor', 'trojan', 'virus', 'exploit']) }}",
                "fileHash": "{{ random_string(64, 'abcdef0123456789') }}",
                "fileHashType": "SHA256"
              }
            ]
          }
        ],
        "sample": false
      }
    },
    "severity": {{ random_choice([2, 5, 5, 8, 8, 8]) }},
    "createdAt": "{{ (now() | subtract_seconds(random_int(0, 7200))) | iso8601 }}",
    "updatedAt": "{{ now() | iso8601 }}",
    "title": "{{ random_choice([
      'Malicious file detected in EBS snapshot',
      'Malicious file detected in EC2 AMI',
      'Malicious file detected in AWS Backup EC2 Recovery Point',
      'Malicious file detected in AWS Backup S3 Recovery Point'
    ]) }}",
    "description": "{{ random_choice([
      'GuardDuty Malware Protection for Backup scan detected one or more malicious files in an EBS snapshot within your environment.',
      'GuardDuty Malware Protection for Backup scan detected one or more malicious files in an AMI within your environment.',
      'GuardDuty Malware Protection for Backup scan detected one or more malicious files in an EC2 recovery point within your environment. The impacted Recovery Point could be an EBS snapshot or an EC2 AMI.',
      'GuardDuty Malware Protection for Backup scan detected one or more malicious objects in an S3 Recovery Point within your environment.'
    ]) }}"
  }
}

