{
  "version": "0",
  "id": "{{ random_guid() }}",
  "detail-type": "GuardDuty Finding",
  "source": "aws.guardduty",
  "account": "{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}",
  "time": "{{ now() | iso8601 }}",
  "region": "{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2', 'eu-west-1', 'eu-central-1']) }}",
  "resources": [],
  "detail": {
    "schemaVersion": "2.0",
    "accountId": "{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}",
    "region": "{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2', 'eu-west-1']) }}",
    "partition": "aws",
    "id": "{{ random_hex(32, 32) }}",
    "arn": "arn:aws:guardduty:{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2']) }}:{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}:detector/{{ random_string(12) }}/finding/{{ random_hex(32, 32) }}",
    "type": "{{ random_choice([
      'Execution:EC2/MaliciousFile',
      'Execution:ECS/MaliciousFile',
      'Execution:Kubernetes/MaliciousFile',
      'Execution:Container/MaliciousFile',
      'Execution:EC2/SuspiciousFile',
      'Execution:ECS/SuspiciousFile',
      'Execution:Kubernetes/SuspiciousFile',
      'Execution:Container/SuspiciousFile'
    ]) }}",
    "resource": {
      "resourceType": "{{ random_choice(['Instance', 'EKSCluster', 'ECSCluster', 'Container']) }}",
      "instanceDetails": {
        "instanceId": "i-{{ random_hex(17, 17) }}",
        "instanceType": "{{ random_choice(['t2.micro', 't2.small', 't3.micro', 't3.small', 'm5.large', 'm5.xlarge', 'c5.large']) }}",
        "launchTime": {{ (now() | unix_timestamp) - random_int(3600, 2592000) }}000,
        "networkInterfaces": [{
          "ipv6Addresses": [],
          "privateDnsName": "ip-{{ random_private_ip() | replace('.', '-') }}.{{ random_choice(['us-east-1', 'us-west-2']) }}.compute.internal",
          "privateIpAddress": "{{ random_private_ip() }}",
          "subnetId": "subnet-{{ random_hex(8, 8) }}",
          "vpcId": "vpc-{{ random_hex(8, 8) }}",
          "publicDnsName": "ec2-{{ random_public_ip() | replace('.', '-') }}.{{ random_choice(['us-east-1', 'us-west-2']) }}.compute.amazonaws.com",
          "publicIp": "{{ random_public_ip() }}"
        }],
        "imageId": "ami-{{ random_hex(8, 8) }}",
        "imageDescription": "{{ random_choice(['Amazon Linux 2023', 'Amazon Linux 2', 'Ubuntu Server 22.04 LTS', 'Ubuntu Server 20.04 LTS']) }}"
      },
      "eksClusterDetails": {
        "name": "{{ random_choice(['production-cluster', 'staging-cluster', 'development-cluster']) }}-{{ random_int(1000, 9999) }}",
        "arn": "arn:aws:eks:{{ random_choice(['us-east-1', 'us-east-2']) }}:{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}:cluster/{{ random_choice(['production-cluster', 'staging-cluster']) }}-{{ random_int(1000, 9999) }}",
        "vpcId": "vpc-{{ random_hex(8, 8) }}",
        "subnetIds": [
          "subnet-{{ random_hex(8, 8) }}",
          "subnet-{{ random_hex(8, 8) }}"
        ],
        "tags": [
          {
            "key": "Environment",
            "value": "{{ random_choice(['Production', 'Staging', 'Development']) }}"
          }
        ],
        "kubernetesVersion": "{{ random_choice(['1.28', '1.27', '1.26']) }}"
      },
      "ecsClusterDetails": {
        "name": "{{ random_choice(['production-cluster', 'staging-cluster', 'development-cluster']) }}-{{ random_int(1000, 9999) }}",
        "arn": "arn:aws:ecs:{{ random_choice(['us-east-1', 'us-east-2']) }}:{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}:cluster/{{ random_choice(['production-cluster', 'staging-cluster']) }}-{{ random_int(1000, 9999) }}"
      },
      "containerDetails": {
        "containerRuntime": "{{ random_choice(['docker', 'containerd', 'cri-o']) }}",
        "id": "{{ random_string(64, 'abcdef0123456789') }}",
        "name": "{{ random_choice(['web-server', 'api-service', 'database-proxy']) }}-{{ random_int(100, 999) }}",
        "image": "{{ random_choice(['nginx:latest', 'redis:alpine', 'postgres:15']) }}",
        "imagePrefix": "{{ random_choice(['docker.io/library', '123456789012.dkr.ecr.us-east-1.amazonaws.com']) }}",
        "volumeMounts": [
          {
            "name": "{{ random_choice(['config', 'data']) }}",
            "mountPath": "/{{ random_choice(['etc', 'var']) }}/{{ random_choice(['config', 'data']) }}"
          }
        ],
        "securityContext": {
          "privileged": {{ random_choice(['true', 'false']) }},
          "allowPrivilegeEscalation": {{ random_choice(['true', 'false']) }}
        }
      }
    },
    "service": {
      "serviceName": "guardduty",
      "detectorId": "{{ random_hex(32, 32) }}",
      "malwareProtectionScanDetails": {
        "scanId": "{{ random_guid() }}",
        "scanStartTime": "{{ (now() | subtract_seconds(random_int(3600, 86400))) | iso8601 }}",
        "scanEndTime": "{{ (now() | subtract_seconds(random_int(0, 3600))) | iso8601 }}",
        "scannedResourceDetails": {
          "instanceArn": "arn:aws:ec2:{{ random_choice(['us-east-1', 'us-east-2']) }}:{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}:instance/i-{{ random_hex(17, 17) }}",
          "snapshotArn": "arn:aws:ec2:{{ random_choice(['us-east-1', 'us-east-2']) }}:snapshot/snap-{{ random_hex(8, 8) }}",
          "accountId": "{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}",
          "volumeDetails": [
            {
              "volumeArn": "arn:aws:ec2:{{ random_choice(['us-east-1', 'us-east-2']) }}:volume/vol-{{ random_hex(8, 8) }}",
              "volumeType": "{{ random_choice(['gp3', 'gp2', 'io1', 'io2']) }}",
              "deviceName": "/dev/sda1",
              "volumeSizeInGB": {{ random_int(20, 500) }},
              "encryptionType": "{{ random_choice(['ENCRYPTED', 'NOT_ENCRYPTED']) }}"
            }
          ]
        },
        "triggerFindingId": "{{ random_hex(32, 32) }}",
        "sources": [
          "{{ random_choice(['THREAT_DETECTION', 'SCHEDULED_SCAN']) }}"
        ]
      },
      "action": {
        "actionType": "NETWORK_CONNECTION",
        "networkConnectionAction": {
          "connectionDirection": "OUTBOUND",
          "remoteIpDetails": {
            "ipAddressV4": "{{ random_public_ip() }}",
            "organization": {
              "asn": {{ random_int(1, 65535) }},
              "asnOrg": "{{ random_choice(['AS-AMAZON', 'AS-GOOGLE', 'AS-UNKNOWN']) }}",
              "isp": "{{ random_choice(['Amazon Technologies Inc.', 'Google LLC', 'Unknown ISP']) }}",
              "org": "{{ random_choice(['Amazon', 'Google Cloud', 'Unknown']) }}"
            },
            "country": {
              "countryName": "{{ random_choice(['United States', 'China', 'Germany']) }}"
            }
          },
          "remotePortDetails": {
            "port": {{ random_choice([80, 443, 8333, 4444]) }},
            "portName": "{{ random_choice(['HTTP', 'HTTPS', 'Bitcoin', 'Unknown']) }}"
          },
          "protocol": "TCP",
          "blocked": false
        }
      },
      "resourceRole": "TARGET",
      "eventFirstSeen": "{{ (now() | subtract_seconds(random_int(0, 3600))) | iso8601 }}",
      "eventLastSeen": "{{ now() | iso8601 }}",
      "archived": false,
      "count": 1,
      "additionalInfo": {
        "threatsDetectedItemCount": {{ random_int(1, 32) }},
        "threatsDetected": [
          {
            "threatName": "{{ random_choice(['Trojan.Win32.Generic', 'Trojan.Linux.Generic', 'Backdoor.Linux.Generic', 'Virus.Win32.Generic', 'Adware.Mac.Generic', 'Spyware.Win32.Generic', 'Ransomware.Win32.Generic', 'Trojan.Android.Generic', 'PUA.Win32.Generic', 'Rootkit.Linux.Generic', 'Miner.Linux.Generic', 'Worm.Win32.Generic']) }}",
            "severity": {{ random_choice([2, 5, 8, 8, 8]) }},
            "itemCount": {{ random_int(1, 10) }},
            "files": [
              {
                "filePath": "{{ random_choice(['/tmp/malware.exe', '/var/tmp/suspicious.sh', '/root/.ssh/backdoor', '/usr/local/bin/trojan', '/home/ubuntu/downloads/virus', '/opt/malware/bin']) }}",
                "fileName": "{{ random_choice(['malware.exe', 'suspicious.sh', 'backdoor', 'trojan', 'virus', 'exploit']) }}",
                "fileHash": "{{ random_string(64, 'abcdef0123456789') }}",
                "fileHashType": "SHA256"
              }
            ]
          }
        ],
        "sample": false
      }
    },
    "severity": {{ random_choice([2, 5, 5, 8, 8, 8]) }},
    "createdAt": "{{ (now() | subtract_seconds(random_int(0, 7200))) | iso8601 }}",
    "updatedAt": "{{ now() | iso8601 }}",
    "title": "{{ random_choice([
      'Malicious file detected on EC2 instance',
      'Malicious file detected on ECS cluster',
      'Malicious file detected on Kubernetes cluster',
      'Malicious file detected on container',
      'Suspicious file detected on EC2 instance',
      'Suspicious file detected on ECS cluster',
      'Suspicious file detected on Kubernetes cluster',
      'Suspicious file detected on container'
    ]) }}",
    "description": "{{ random_choice([
      'GuardDuty Malware Protection for EC2 scan detected one or more malicious files on the listed EC2 instance within your AWS environment. This listed instance might be compromised.',
      'GuardDuty Malware Protection for EC2 scan detected one or more malicious files on a container workload that belongs to an ECS cluster.',
      'GuardDuty Malware Protection for EC2 scan detected one or more malicious files on a container workload that belongs to a Kubernetes cluster.',
      'GuardDuty Malware Protection for EC2 scan detected one or more malicious files on a container workload and no cluster information has been identified.',
      'GuardDuty Malware Protection for EC2 scan detected one or more suspicious files on an EC2 instance. SuspiciousFile type detections indicate potentially unwanted programs such as adware, spyware, or dual use tools.',
      'GuardDuty Malware Protection for EC2 scan detected one or more suspicious files on a container that belongs to an ECS cluster. SuspiciousFile type detections indicate potentially unwanted programs such as adware, spyware, or dual use tools.',
      'GuardDuty Malware Protection for EC2 scan detected one or more suspicious files on a container that belongs to a Kubernetes cluster. SuspiciousFile type detections indicate potentially unwanted programs such as adware, spyware, or dual use tools.',
      'GuardDuty Malware Protection for EC2 scan detected one or more suspicious files on a container with no cluster information. SuspiciousFile type detections indicate potentially unwanted programs such as adware, spyware, or dual use tools.'
    ]) }}"
  }
}

