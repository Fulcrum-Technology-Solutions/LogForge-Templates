{
  "version": "0",
  "id": "{{ random_guid() }}",
  "detail-type": "GuardDuty Finding",
  "source": "aws.guardduty",
  "account": "{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}",
  "time": "{{ now() | iso8601 }}",
  "region": "{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2', 'eu-west-1', 'eu-central-1']) }}",
  "resources": [],
  "detail": {
    "schemaVersion": "2.0",
    "accountId": "{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}",
    "region": "{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2', 'eu-west-1']) }}",
    "partition": "aws",
    "id": "{{ random_hex(32, 32) }}",
    "arn": "arn:aws:guardduty:{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1', 'us-west-2']) }}:{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}:detector/{{ random_string(12) }}/finding/{{ random_hex(32, 32) }}",
    "type": "{{ random_choice([
      'Backdoor:Lambda/C&CActivity.B',
      'CryptoCurrency:Lambda/BitcoinTool.B',
      'Trojan:Lambda/BlackholeTraffic',
      'Trojan:Lambda/DropPoint',
      'UnauthorizedAccess:Lambda/MaliciousIPCaller.Custom',
      'UnauthorizedAccess:Lambda/TorClient',
      'UnauthorizedAccess:Lambda/TorRelay'
    ]) }}",
    "resource": {
      "resourceType": "Lambda",
      "lambdaDetails": {
        "functionArn": "arn:aws:lambda:{{ random_choice(['us-east-1', 'us-east-2', 'us-west-1']) }}:{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}:function:{{ random_choice(['api-handler', 'data-processor', 'image-resizer', 'email-sender', 'webhook-receiver', 'scheduled-task']) }}",
        "functionName": "{{ random_choice(['api-handler', 'data-processor', 'image-resizer', 'email-sender', 'webhook-receiver', 'scheduled-task']) }}",
        "description": "{{ random_choice(['API request handler', 'Data processing function', 'Image resizing service', 'Email notification sender', 'Webhook receiver endpoint', 'Scheduled background task']) }}",
        "lastModifiedAt": {{ (now() | unix_timestamp) - random_int(86400, 31536000) }},
        "revisionId": "{{ random_string(36, 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-') }}",
        "functionVersion": "{{ random_choice(['$LATEST', '1', '2', '3', '4', '5']) }}",
        "role": "arn:aws:iam::{{ registry.get_organization_field('aws_account_id') | default('123456789012', true) }}:role/{{ random_choice(['lambda-execution-role', 'lambda-api-role', 'lambda-processing-role']) }}",
        "vpcConfig": {
          "vpcId": "vpc-{{ random_hex(8, 8) }}",
          "subnetIds": [
            "subnet-{{ random_hex(8, 8) }}",
            "subnet-{{ random_hex(8, 8) }}"
          ],
          "securityGroupIds": [
            "sg-{{ random_hex(8, 8) }}"
          ]
        },
        "codeSize": {{ random_int(1024, 52428800) }},
        "deadLetterConfig": {
          "targetArn": "{{ random_choice(['null', 'arn:aws:sqs:us-east-1:' ~ (registry.get_organization_field('aws_account_id') | default('123456789012', true)) ~ ':queue/dlq-' ~ random_string(16)]) }}"
        },
        "timeout": {{ random_choice([3, 10, 30, 60, 300, 900]) }},
        "memorySize": {{ random_choice([128, 256, 512, 1024, 2048, 3008]) }},
        "runtime": "{{ random_choice(['python3.11', 'python3.12', 'nodejs20.x', 'nodejs18.x', 'java17', 'java21', 'go1.x', 'ruby3.2', 'dotnet8']) }}",
        "handler": "{{ random_choice(['index.handler', 'lambda_function.lambda_handler', 'com.example.Handler::handleRequest', 'main', 'app.lambda_handler']) }}"
      }
    },
    "service": {
      "serviceName": "guardduty",
      "detectorId": "{{ random_hex(32, 32) }}",
      "action": {
        "actionType": "NETWORK_CONNECTION",
        "networkConnectionAction": {
          "connectionDirection": "{{ random_choice(['OUTBOUND', 'INBOUND']) }}",
          "remoteIpDetails": {
            "ipAddressV4": "{{ random_public_ip() }}",
            "organization": {
              "asn": {{ random_int(1, 65535) }},
              "asnOrg": "{{ random_choice(['AS-AMAZON', 'AS-GOOGLE', 'AS-TOR', 'AS-UNKNOWN', 'AS-MALICIOUS']) }}",
              "isp": "{{ random_choice(['Amazon Technologies Inc.', 'Google LLC', 'Tor Network', 'Unknown ISP', 'Suspicious ISP']) }}",
              "org": "{{ random_choice(['Amazon', 'Google Cloud', 'Tor Exit Node', 'Unknown', 'Malicious Network']) }}"
            },
            "country": {
              "countryName": "{{ random_choice(['United States', 'China', 'Russia', 'Germany', 'Netherlands', 'Ukraine']) }}"
            },
            "city": {
              "cityName": "{{ random_choice(['Unknown', 'Beijing', 'Moscow', 'Frankfurt', 'Amsterdam', 'Kiev']) }}"
            },
            "geoLocation": {
              "lat": {{ random_int(-90, 90) }},
              "lon": {{ random_int(-180, 180) }}
            }
          },
          "remotePortDetails": {
            "port": {{ random_choice([80, 443, 8333, 8332, 4444, 8080, 9999, 5555]) }},
            "portName": "{{ random_choice(['HTTP', 'HTTPS', 'Bitcoin', 'Bitcoin-RPC', 'Unknown']) }}"
          },
          "localPortDetails": {
            "port": {{ random_port(1024, 65535) }},
            "portName": "Unknown"
          },
          "protocol": "{{ random_choice(['TCP', 'UDP']) }}",
          "blocked": {{ random_choice(['true', 'false']) }}
        },
        "dnsRequestAction": {
          "domain": "{{ random_choice(['guarddutyc2activityb.com', 'bitcoin-pool.com', 'crypto-mine.xyz', 'malicious-domain.ru', 'tor-relay-node.onion']) }}",
          "protocol": "{{ random_choice(['UDP', 'TCP']) }}",
          "blocked": {{ random_choice(['true', 'false']) }}
        }
      },
      "resourceRole": "TARGET",
      "eventFirstSeen": "{{ (now() | subtract_seconds(random_int(0, 3600))) | iso8601 }}",
      "eventLastSeen": "{{ now() | iso8601 }}",
      "archived": false,
      "count": {{ random_int(1, 100) }},
      "additionalInfo": {
        "threatListName": "{{ random_choice(['ProofPoint', 'Custom Threat List', 'AWS Threat Intelligence', 'Tor Exit Nodes', 'Amazon']) }}",
        "threatName": "{{ random_choice(['C&C Server', 'Bitcoin Mining', 'Tor Network', 'Malicious Domain', 'Log4j Related']) }}",
        "sample": false
      }
    },
    "severity": {{ random_choice([8, 8, 8]) }},
    "createdAt": "{{ (now() | subtract_seconds(random_int(0, 7200))) | iso8601 }}",
    "updatedAt": "{{ now() | iso8601 }}",
    "title": "{{ random_choice([
      'Lambda function querying known command and control server',
      'Lambda function querying cryptocurrency-related IP address',
      'Lambda function blackhole traffic pattern detected',
      'Lambda function drop point trojan activity detected',
      'Lambda function making connections to known malicious IP address',
      'Lambda function making connections to Tor Guard or Authority node',
      'Lambda function acting as Tor relay'
    ]) }}",
    "description": "{{ random_choice([
      'GuardDuty detected that a Lambda function in your AWS environment is querying an IP address that is associated with a known command and control server. C&C servers are computers that issue commands to members of a botnet. The Lambda function associated to the generated finding is potentially compromised.',
      'GuardDuty detected that a Lambda function in your AWS environment is querying an IP address that is associated with cryptocurrency-related activity. Threat actors may seek to take control over compute resources to maliciously repurpose them for unauthorized cryptocurrency mining.',
      'GuardDuty detected a blackhole traffic pattern from a Lambda function in your AWS environment. This indicates potential malicious network behavior.',
      'GuardDuty detected drop point trojan activity from a Lambda function in your AWS environment. The Lambda function may be compromised and used as a drop point for malicious payloads.',
      'GuardDuty detected that a Lambda function in your AWS environment is making connections to a known malicious IP address. This indicates that the Lambda function may have been potentially compromised.',
      'GuardDuty detected that a Lambda function in your AWS environment is making connections to a Tor Guard or Authority node. Tor is software for enabling anonymous communication. Tor Guards and Authority nodes act as initial gateways into a Tor network. This traffic can indicate that this Lambda function has been potentially compromised.',
      'GuardDuty detected that a Lambda function in your AWS environment is making connections to a Tor network in a manner that suggests it is acting as a Tor relay. Tor enables anonymous communication by forwarding the client\'s potentially illicit traffic from one Tor relay to another.'
    ]) }}"
  }
}

